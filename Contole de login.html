<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SGP - Sistema de Gerenciamento de PDAs</title>
<!-- Ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --bg: #f3f4f6; --card: #ffffff; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
.container { max-width: 1200px; margin: auto; }

/* Header & Dashboard */
header { text-align: center; margin-bottom: 30px; }
h1 { color: #1e293b; margin-bottom: 5px; }
.subtitle { color: #64748b; font-size: 0.9rem; }

.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.metric-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); display: flex; align-items: center; justify-content: space-between; }
.metric-card.success { border-color: var(--success); }
.metric-card.danger { border-color: var(--danger); }
.metric-info h3 { margin: 0; font-size: 0.9rem; color: #64748b; }
.metric-info p { margin: 5px 0 0; font-size: 1.8rem; font-weight: bold; color: #1e293b; }
.metric-icon { font-size: 2rem; opacity: 0.2; }

/* Tabs */
.tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; }
.tab { padding: 12px 25px; border-radius: 30px; background: #e2e8f0; cursor: pointer; font-weight: 600; transition: 0.3s; border: none; color: #475569; }
.tab:hover { background: #cbd5e1; }
.tab.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

/* Cards & Forms */
.card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
.card h2 { margin-top: 0; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; font-size: 1.25rem; }

.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

.btn { cursor: pointer; border: none; font-weight: bold; color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; }
.btn-primary { background: var(--primary); }
.btn-success { background: var(--success); }
.btn-danger { background: var(--danger); }
.btn-warning { background: var(--warning); color: #fff; }
.btn:hover { opacity: 0.9; transform: translateY(-1px); }

/* Tables */
.table-responsive { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.95rem; }
th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
tr:hover { background: #f8fafc; }

/* Status Badges */
.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
.badge-avail { background: #d1fae5; color: #065f46; }
.badge-busy { background: #fee2e2; color: #991b1b; }
.badge-done { background: #eff6ff; color: #1e40af; }

/* Utilities */
.hidden { display: none !important; }
.toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: #fff; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); opacity: 0; transition: 0.3s; transform: translateY(20px); z-index: 1000; }
.toast.show { opacity: 1; transform: translateY(0); }
.chart-container { position: relative; height: 250px; width: 100%; }
.actions-cell { display: flex; gap: 5px; }

/* Ajustes para tabelas de senhas */
.tabela-senhas th, .tabela-senhas td { font-size: 0.9rem; white-space: nowrap; }
.tabela-senhas thead th { background: #e0f2fe; color: #1e40af; }

/* Destaque de login em uso / disponível */
.tabela-senhas tr.login-ocupado {
    background-color: #fee2e2 !important;
    color: #b91c1c !important;
    font-weight: 600;
}
.tabela-senhas tr.login-ocupado td {
    color: #b91c1c !important;
}
.tabela-senhas tr.login-disponivel {
    background-color: #ecfdf5 !important;
    color: #065f46 !important;
    font-weight: 500;
}
.tabela-senhas tr.login-disponivel td {
    color: #065f46 !important;
}

.login-check-container {
    margin: 20px 0 30px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}
.login-check-container label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    color: #334155;
}
.status-msg {
    margin-top: 8px;
    font-weight: 500;
}
.status-msg.ocupado { color: #b91c1c; }
.status-msg.disponivel { color: #059669; }

/* Pequeno ajuste para melhorar alinhamento dos cards na aba estoque */
.form-grid.dois-cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    align-items: stretch;
}
.form-grid.dois-cards > .card {
    display: flex;
    flex-direction: column;
}

/* ===== MODAL PDA DETALHES ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-card {
    background: #fff;
    width: 90%;
    max-width: 800px;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    animation: fadeIn 0.2s ease-in-out;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-header h3 {
    margin: 0;
}

.modal-close {
    cursor: pointer;
    font-size: 20px;
    color: #ef4444;
}

.qr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    text-align: center;
}

.qr-item {
    background: #f8fafc;
    padding: 15px;
    border-radius: 12px;
}

.qr-item img {
    width: 120px;
    height: 120px;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fa-solid fa-boxes-stacked"></i> Controle Operacional de PDAs</h1>
        <p class="subtitle">Gerenciamento de Estoque e Produtividade</p>
    </header>

    <!-- DASHBOARD -->
    <div class="dashboard">
        <div class="metric-card">
            <div class="metric-info">
                <h3>Total PDAs</h3>
                <p id="dashTotal">0</p>
            </div>
            <i class="fa-solid fa-mobile-screen metric-icon"></i>
        </div>
        <div class="metric-card danger">
            <div class="metric-info">
                <h3>Em Uso</h3>
                <p id="dashUso">0</p>
            </div>
            <i class="fa-solid fa-user-clock metric-icon"></i>
        </div>
        <div class="metric-card success">
            <div class="metric-info">
                <h3>Disponíveis</h3>
                <p id="dashDisp">0</p>
            </div>
            <i class="fa-solid fa-check-circle metric-icon"></i>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="abrirAba('operacional')"><i class="fa-solid fa-dolly"></i> Operações</button>
        <button class="tab" onclick="abrirAba('estoque')"><i class="fa-solid fa-warehouse"></i> Estoque & Gráficos</button>
        <button class="tab" onclick="abrirAba('historico')"><i class="fa-solid fa-clock-rotate-left"></i> Histórico</button>
    </div>

    <!-- ABA OPERACIONAL -->
    <div id="operacional" class="aba">
        <!-- Nova Operação -->
        <div class="card">
            <h2><i class="fa-solid fa-circle-play"></i> Iniciar Operação (Empréstimo)</h2>
            <div class="form-grid">
                <select id="opArea">
                    <option value="" disabled selected>Selecione a Área</option>
                    <option>Chegada</option>
                    <option>Consolidação</option>
                    <option>Expedição</option>
                </select>
                <input id="opColaborador" placeholder="Nome do Colaborador">
                <input id="opLogin" placeholder="Login / Matrícula">
                <input id="opNumeroPda" placeholder="Número do PDA (opcional)">
                <select id="opPdaSelect">
                    <option value="">Carregando PDAs...</option>
                </select>
                <button class="btn btn-primary" onclick="iniciarOperacao()"><i class="fa-solid fa-plus"></i> Alocar PDA</button>
            </div>
        </div>

        <!-- Tabela de PDAs em Uso -->
        <div class="card">
            <h2><i class="fa-solid fa-person-digging"></i> PDAs em Uso (Ativos)</h2>
            <div style="margin: 15px 0; max-width: 400px;">
                <input 
                    id="filtroAtivos" 
                    placeholder="Filtrar por colaborador ou nº PDA..." 
                    style="width:100%;"
                    oninput="filtrarTabelaAtivos()"
                >
            </div>
            <div class="table-responsive">
                <table id="tabelaAtivos">
                    <thead>
                        <tr>
                            <th>PDA</th>
                            <th>Colaborador</th>
                            <th>Área</th>
                            <th>Início</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ABA ESTOQUE -->
    <div id="estoque" class="aba hidden">
        <div class="form-grid dois-cards">
            <!-- Card 1: Cadastro PDA -->
            <div class="card">
                <h2><i class="fa-solid fa-plus-circle"></i> Cadastrar Novo PDA</h2>
                <div class="form-grid">
                    <input id="novoPdaNome" placeholder="Ex: PDA-05, ZEBRA-01">
                    <button class="btn btn-success" onclick="adicionarAoEstoque()">Adicionar</button>
                </div>
                <div class="table-responsive">
                    <table id="tabelaEstoque">
                        <thead><tr><th>PDA</th><th>Status</th><th>Ação</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Card 2: Listas por Área + Verificação de Login -->
            <div class="card">
                <h2><i class="fa-solid fa-list-check"></i> PDAs Cadastrados por Área</h2>

                <!-- Campo de verificação de login -->
                <div class="login-check-container">
                    <label for="novoLogin"><i class="fa-solid fa-user"></i> Verificar / Cadastrar Novo Login</label>
                    <input type="text" id="novoLogin" placeholder="Digite o login / matrícula..." autocomplete="off">
                    <div id="statusLogin" class="status-msg"></div>
                </div>

                <h4>Chegada</h4>
                <div class="table-responsive">
                    <table class="tabela-senhas" id="tabelaChegada">
                        <thead>
                            <tr>
                                <th>Nome do PDA</th>
                                <th>Login</th>
                                <th>Senha 1</th>
                                <th>Senha 2</th>
                                <th>Senha 3</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>EVO-Test1</td><td>2105099801</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                            <tr><td>EVO-Test2</td><td>2104118501</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                            <tr><td>EVO-Test3</td><td>2104118501</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                        </tbody>
                    </table>
                </div>

                <h4>Consolidação</h4>
                <div class="table-responsive">
                    <table class="tabela-senhas" id="tabelaConsolidacao">
                        <thead>
                            <tr>
                                <th>Nome do PDA</th>
                                <th>Login</th>
                                <th>Senha 1</th>
                                <th>Senha 2</th>
                                <th>Senha 3</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>SP2T2-1001</td><td>2105099801</td><td>123456a.</td><td>N/A</td><td>N/A</td></tr>
                            <tr><td>SP2T2-1002</td><td>2105099901</td><td>123456a.</td><td>N/A</td><td>N/A</td></tr>
                            <tr><td>SP2T2-1003</td><td>2105100001</td><td>123456a.</td><td>N/A</td><td>N/A</td></tr>
                            <tr><td>SP2T2-1004</td><td>2105100101</td><td>123456a.</td><td>N/A</td><td>N/A</td></tr>
                            <tr><td>SP2T2-1005</td><td>2105100201</td><td>123456a.</td><td>N/A</td><td>N/A</td></tr>
                            <tr><td>CONSOLID.RDC SP2 01</td><td>2104118401</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                            <tr><td>CONSOLID.RDC SP2 02</td><td>2104118501</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                        </tbody>
                    </table>
                </div>

                <h4>Expedição</h4>
                <div class="table-responsive">
                    <table class="tabela-senhas" id="tabelaExpedicao">
                        <thead>
                            <tr>
                                <th>Nome do PDA</th>
                                <th>Login</th>
                                <th>Senha 1</th>
                                <th>Senha 2</th>
                                <th>Senha 3</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>EXPEDIÇÂO RDC-SP2 01</td><td>2104124901</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                            <tr><td>EXPEDIÇÂO RDC-SP2 02</td><td>2104125001</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                        </tbody>
                    </table>
                </div>

                <h4>Dona Nubia</h4>
                <div class="table-responsive">
                    <table class="tabela-senhas" id="tabelaDonaNubia">
                        <thead>
                            <tr>
                                <th>Nome do PDA</th>
                                <th>Login</th>
                                <th>Senha 1</th>
                                <th>Senha 2</th>
                                <th>Senha 3</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>SECUNDARIA EXPED.07</td><td>2104118301</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                            <tr><td>SECUNDARIA EXPED.08</td><td>2104118201</td><td>123456a.</td><td>rdcsp2a.</td><td>654321a.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gráfico -->
        <div class="card" style="margin-top: 25px;">
            <h2><i class="fa-solid fa-chart-pie"></i> Status da Frota</h2>
            <div class="chart-container">
                <canvas id="graficoStatus"></canvas>
            </div>
        </div>
    </div>

    <!-- ABA HISTÓRICO -->
    <div id="historico" class="aba hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
                <h2><i class="fa-solid fa-list"></i> Histórico Completo</h2>
                <div>
                    <button class="btn btn-primary" onclick="gerarRelatorio()"><i class="fa-solid fa-file-lines"></i> Gerar Relatório</button>
                    <button class="btn btn-danger" onclick="limparHistorico()"><i class="fa-solid fa-trash-can"></i> Limpar Histórico</button>
                    <button class="btn btn-success" onclick="exportarExcel()"><i class="fa-solid fa-file-excel"></i> Exportar CSV</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="tabelaHistorico">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Colaborador</th>
                            <th>Área</th>
                            <th>PDA</th>
                            <th>Produção</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<div id="toast" class="toast"></div>

<!-- MODAL PDA DETALHES -->
<div id="modalPDA" class="modal-overlay hidden">
    <div class="modal-card">
        <div class="modal-header">
            <h3 id="modalTitulo"></h3>
            <i class="fa-solid fa-xmark modal-close" onclick="fecharModalPDA()"></i>
        </div>
        <div id="modalConteudo"></div>
        <div style="margin-top:20px; text-align:right;">
            <button class="btn btn-primary" id="btnIniciarOperacaoModal">
                <i class="fa-solid fa-circle-play"></i> Iniciar Operação
            </button>
        </div>
    </div>
</div>

<script>
// --- BANCO DE DADOS (LOCALSTORAGE) ---
let estoque = JSON.parse(localStorage.getItem("db_estoque")) || []; 
let operacoes = JSON.parse(localStorage.getItem("db_operacoes")) || [];

// --- INICIALIZAÇÃO ---
let chartInstance = null;

document.addEventListener("DOMContentLoaded", () => {
    atualizarTudo();

    // Evento de verificação de login em tempo real
    const inputLogin = document.getElementById("novoLogin");
    if (inputLogin) {
        inputLogin.addEventListener("input", verificarDisponibilidadeLogin);
        // Opcional: limpar ao perder foco
        inputLogin.addEventListener("blur", limparDestaquesLogin);
    }

    // Clique nas linhas das tabelas de senhas
    document.querySelectorAll(".tabela-senhas tbody tr").forEach(row => {
        row.style.cursor = "pointer";
        row.addEventListener("click", () => {
            const cols = row.querySelectorAll("td");
            const nome = cols[0]?.innerText || "";
            const login = cols[1]?.innerText || "";
            const s1 = cols[2]?.innerText || "";
            const s2 = cols[3]?.innerText || "";
            const s3 = cols[4]?.innerText || "";
            abrirModalPDA(nome, login, s1, s2, s3);
        });
    });
});

// ======================
//  VERIFICAÇÃO DE LOGIN
// ======================
function verificarDisponibilidadeLogin() {
    const login = document.getElementById("novoLogin").value.trim();
    const statusDiv = document.getElementById("statusLogin");

    // Limpa destaques anteriores
    document.querySelectorAll(".tabela-senhas tr").forEach(r => {
        r.classList.remove("login-ocupado", "login-disponivel");
    });

    if (!login) {
        statusDiv.textContent = "";
        statusDiv.className = "status-msg";
        return;
    }

    let encontrado = false;

    document.querySelectorAll(".tabela-senhas tbody tr").forEach(row => {
        const celulaLogin = row.cells[1];
        if (celulaLogin && celulaLogin.textContent.trim() === login) {
            row.classList.add("login-ocupado");
            encontrado = true;
        }
    });

    if (encontrado) {
        statusDiv.textContent = "Este login JÁ ESTÁ EM USO";
        statusDiv.className = "status-msg ocupado";
    } else {
        statusDiv.textContent = "Login DISPONÍVEL";
        statusDiv.className = "status-msg disponivel";
        
        // Opcional: destacar todas as linhas em verde (descomente se quiser)
        document.querySelectorAll(".tabela-senhas tbody tr").forEach(r => r.classList.add("login-disponivel"));
    }
}

function limparDestaquesLogin() {
    document.querySelectorAll(".tabela-senhas tr").forEach(r => {
        r.classList.remove("login-ocupado", "login-disponivel");
    });
}

// ======================
//  FUNÇÕES EXISTENTES (mantidas)
// ======================
function abrirAba(id){
    document.querySelectorAll(".aba").forEach(a => a.classList.add("hidden"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.remove("hidden");
    document.querySelector(`.tab[onclick="abrirAba('${id}')"]`).classList.add("active");
    
    if(id === 'estoque') renderChart();
}

function toast(msg, type='info'){
    const t = document.getElementById("toast");
    t.innerHTML = msg;
    t.style.borderLeft = type === 'error' ? '5px solid var(--danger)' : '5px solid var(--success)';
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
}

function atualizarTudo(){
    atualizarDashboard();
    atualizarSelectPDAs();
    renderTabelaAtivos(document.getElementById("filtroAtivos")?.value || "");
    renderTabelaEstoque();
    renderTabelaHistorico();
    salvarDados();
}

function atualizarDashboard(){
    document.getElementById("dashTotal").innerText = estoque.length;
    const emUso = estoque.filter(e => e.status === 'uso').length;
    document.getElementById("dashUso").innerText = emUso;
    document.getElementById("dashDisp").innerText = estoque.length - emUso;
}

function atualizarSelectPDAs(){
    const select = document.getElementById("opPdaSelect");
    if (!select) return;
    select.innerHTML = '<option value="" disabled selected>Selecione um PDA Disponível</option>';
    
    const disponiveis = estoque.filter(e => e.status === 'livre');
    if(disponiveis.length === 0){
        select.innerHTML += '<option disabled>Sem PDAs disponíveis</option>';
        return;
    }
    disponiveis.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.text = p.id;
        select.add(opt);
    });
}

function iniciarOperacao(){
    const area = document.getElementById("opArea")?.value;
    const colab = document.getElementById("opColaborador")?.value.trim();
    const login = document.getElementById("opLogin")?.value.trim();
    const pda = document.getElementById("opPdaSelect")?.value;

    if(!area || !colab || !login || !pda) {
        return toast("Preencha todos os campos obrigatórios", 'error');
    }

    const op = {
        id: Date.now(),
        pda,
        colab,
        area,
        login,
        inicio: new Date().toLocaleString(),
        status: 'ativo'
    };
    operacoes.push(op);

    const idx = estoque.findIndex(e => e.id === pda);
    if (idx !== -1) estoque[idx].status = 'uso';

    salvarDados();
    document.getElementById("opColaborador").value = "";
    document.getElementById("opLogin").value = "";
    document.getElementById("opPdaSelect").value = "";
    toast("PDA alocado com sucesso!");
    atualizarTudo();
}

function devolverPDA(id){
    const qtd = prompt("Quantidade produzida:", "0") || "0";
    const idx = operacoes.findIndex(o => o.id === id);
    if (idx === -1) return;

    operacoes[idx].status = 'concluido';
    operacoes[idx].fim = new Date().toLocaleString();
    operacoes[idx].qtd = parseInt(qtd) || 0;

    const pda = operacoes[idx].pda;
    const estIdx = estoque.findIndex(e => e.id === pda);
    if (estIdx !== -1) estoque[estIdx].status = 'livre';

    salvarDados();
    toast(`Devolução registrada (${qtd} un.)`);
    atualizarTudo();
}

function adicionarAoEstoque(){
    const nome = document.getElementById("novoPdaNome")?.value.trim().toUpperCase();
    if (!nome) return toast("Digite o nome do PDA", 'error');
    if (estoque.some(e => e.id === nome)) return toast("PDA já cadastrado", 'error');

    estoque.push({id: nome, status: 'livre'});
    salvarDados();
    document.getElementById("novoPdaNome").value = "";
    toast("PDA adicionado!");
    atualizarTudo();
}

function renderTabelaAtivos(filtro = "") {
    const tbody = document.querySelector("#tabelaAtivos tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    let ops = operacoes.filter(o => o.status === 'ativo');
    if (filtro.trim()) {
        const term = filtro.toLowerCase();
        ops = ops.filter(o => 
            o.colab.toLowerCase().includes(term) ||
            (o.pda || "").toLowerCase().includes(term)
        );
    }

    if (ops.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Nenhuma operação ativa${filtro ? ' com este filtro' : ''}</td></tr>`;
        return;
    }

    ops.forEach(op => {
        tbody.innerHTML += `
        <tr>
            <td><strong>${op.pda}</strong></td>
            <td>${op.colab}<br><small>${op.login}</small></td>
            <td>${op.area}</td>
            <td>${op.inicio}</td>
            <td><button class="btn btn-warning" style="padding:6px 12px;" onclick="devolverPDA(${op.id})">Devolver</button></td>
        </tr>`;
    });
}

function filtrarTabelaAtivos() {
    renderTabelaAtivos(document.getElementById("filtroAtivos")?.value || "");
}

function renderTabelaEstoque(){
    const tbody = document.querySelector("#tabelaEstoque tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    estoque.forEach(item => {
        const isLivre = item.status === 'livre';
        tbody.innerHTML += `
        <tr>
            <td>${item.id}</td>
            <td><span class="badge ${isLivre ? 'badge-avail' : 'badge-busy'}">${isLivre ? 'Disponível' : 'Em Uso'}</span></td>
            <td>${isLivre ? `<button class="btn btn-danger" style="padding:5px 10px;" onclick="removerDoEstoque('${item.id}')"><i class="fa fa-trash"></i></button>` : '-'}</td>
        </tr>`;
    });
}

function removerDoEstoque(id){
    if (!confirm(`Remover ${id} do estoque?`)) return;
    if (estoque.some(e => e.id === id && e.status === 'uso')) return toast("Não pode remover PDA em uso", 'error');
    
    estoque = estoque.filter(e => e.id !== id);
    salvarDados();
    toast("PDA removido");
    atualizarTudo();
}

function renderTabelaHistorico(){
    const tbody = document.querySelector("#tabelaHistorico tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    
    operacoes
        .filter(o => o.status === 'concluido')
        .sort((a,b) => b.id - a.id)
        .slice(0, 50)
        .forEach(op => {
            tbody.innerHTML += `
            <tr>
                <td>${op.fim || '-'}</td>
                <td>${op.colab}</td>
                <td>${op.area}</td>
                <td>${op.pda}</td>
                <td style="font-weight:bold">${op.qtd || 0}</td>
                <td><span class="badge badge-done">Concluído</span></td>
            </tr>`;
        });
}

function renderChart(){
    const ctx = document.getElementById('graficoStatus')?.getContext('2d');
    if (!ctx) return;

    const livres = estoque.filter(e => e.status === 'livre').length;
    const emUso = estoque.length - livres;

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Disponíveis', 'Em Uso'],
            datasets: [{
                data: [livres, emUso],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function salvarDados(){
    localStorage.setItem("db_estoque", JSON.stringify(estoque));
    localStorage.setItem("db_operacoes", JSON.stringify(operacoes));
}

// Modal PDA
function abrirModalPDA(nome, login, s1, s2, s3) {
    document.getElementById("modalTitulo").innerText = nome;

    const qr = v => v && v !== "N/A" ? `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(v)}` : "";

    let html = `
    <div class="qr-grid">
        <div class="qr-item"><strong>Login</strong><p>${login}</p><img src="${qr(login)}"></div>
        <div class="qr-item"><strong>Senha 1</strong><p>${s1}</p><img src="${qr(s1)}"></div>`;

    if (s2 && s2 !== "N/A") html += `<div class="qr-item"><strong>Senha 2</strong><p>${s2}</p><img src="${qr(s2)}"></div>`;
    if (s3 && s3 !== "N/A") html += `<div class="qr-item"><strong>Senha 3</strong><p>${s3}</p><img src="${qr(s3)}"></div>`;

    html += `</div>`;

    document.getElementById("modalConteudo").innerHTML = html;

    document.getElementById("btnIniciarOperacaoModal").onclick = () => {
        document.getElementById("opLogin").value = login;
        abrirAba('operacional');
        fecharModalPDA();
    };

    document.getElementById("modalPDA").classList.remove("hidden");
}

function fecharModalPDA(){
    document.getElementById("modalPDA").classList.add("hidden");
}

// Funções placeholder
function gerarRelatorio(){ alert("Relatório em desenvolvimento"); }
function limparHistorico(){ alert("Limpar histórico em desenvolvimento"); }
function exportarExcel(){ alert("Exportar CSV em desenvolvimento"); }
</script>

</body>
</html>